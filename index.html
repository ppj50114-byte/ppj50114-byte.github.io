<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>äº‘å–„ç»˜ å›¢é˜Ÿç©ºé—´ â€” æœ€ç»ˆç‰ˆ</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
  body { font-family: Inter, sans-serif; }
  .glass { background: rgba(255,255,255,0.06); backdrop-filter: blur(8px); }
  .modal-bg { position:fixed; left:0;top:0;right:0;bottom:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.75);z-index:60; }
  .modal-content { max-width:95%; max-height:95%; }
  .small { font-size:0.85rem; }
  .highlight { background: yellow; color: black; padding:0 2px; }
</style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-purple-900 to-indigo-900 text-gray-100 min-h-screen">
  <div class="container mx-auto p-6">
    <div class="glass p-6 rounded-2xl shadow-xl">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-3">
          <img src="/logo.png" alt="Logo" class="w-12 h-12 rounded" />
          <div>
            <h1 class="text-2xl font-bold">äº‘å–„ç»˜ å›¢é˜Ÿç©ºé—´</h1>
            <div class="text-sm text-gray-300">æœ€ç»ˆç‰ˆï¼šå…¨åŠŸèƒ½+ç»Ÿè®¡+æœˆæŠ¥å¯¼å‡º</div>
          </div>
        </div>
        <div class="text-right">
          <div id="userBox">æœªç™»å½•</div>
          <div id="onlineInfo" class="text-sm text-gray-300 mt-1"></div>
        </div>
      </div>

      <!-- login/search area -->
      <div id="loginArea" class="mb-4">
        <input id="nameInput" placeholder="å§“å(ä¸­æ–‡)" class="p-2 rounded text-black mr-2" />
        <input id="pwdInput" type="password" placeholder="ç®¡ç†å‘˜å¯†ç " class="p-2 rounded text-black mr-2 hidden" />
        <button id="loginBtn" class="px-3 py-2 bg-indigo-600 rounded">ç™»å½•</button>
        <label class="ml-4 small text-gray-300">åŒ¿åå‘å¸ƒ<input id="anonCheckbox" type="checkbox" class="ml-1"></label>
        <input id="searchInput" placeholder="æœç´¢" class="ml-4 p-2 rounded text-black w-56" />
        <button id="searchBtn" class="px-3 py-2 bg-gray-700 rounded ml-2">æœç´¢</button>
      </div>

      <div id="appArea" class="hidden">
        <div class="flex items-center justify-between mb-4">
          <div class="grid grid-cols-6 gap-2 flex-1">
            <button class="tab p-3 rounded bg-indigo-700" data-tab="news">æ–°é—»</button>
            <button class="tab p-3 rounded bg-indigo-700" data-tab="photos">ç…§ç‰‡</button>
            <button class="tab p-3 rounded bg-indigo-700" data-tab="videos">è§†é¢‘</button>
            <button class="tab p-3 rounded bg-indigo-700" data-tab="wishes">æ„¿æœ›æ± </button>
            <button id="statsBtn" class="tab p-3 rounded bg-gray-700 hidden">ç»Ÿè®¡</button>
            <div id="spacer"></div>
          </div>
          <div class="ml-4 small text-gray-300">å½“å‰: <span id="meName"></span></div>
        </div>

        <div id="contentArea"></div>

        <!-- admin panel -->
        <div id="adminPanel" class="hidden mt-6 p-4 bg-gray-800 rounded">
          <h3 class="font-bold mb-2">ç®¡ç†å‘˜æ“ä½œ</h3>
          <div class="grid grid-cols-3 gap-4">
            <div>
              <h4 class="font-semibold">å‘å¸ƒæ–°é—»</h4>
              <input id="newsTitle" placeholder="æ ‡é¢˜" class="w-full p-1 text-black rounded mb-1" />
              <textarea id="newsContent" placeholder="æ­£æ–‡" class="w-full p-1 text-black rounded mb-1"></textarea>
              <select id="newsTag" class="w-full p-1 rounded mb-1 text-black"><option>å…¬å‘Š</option><option>æ´»åŠ¨</option><option>å­¦ä¹ </option><option>å…¶ä»–</option></select>
              <label class="inline-flex items-center small"><input id="newsPinned" type="checkbox" class="mr-2">ç½®é¡¶</label>
              <input id="newsImageFile" type="file" class="w-full mt-1 mb-1" />
              <button id="postNews" class="px-2 py-1 bg-green-600 rounded">å‘å¸ƒæ–°é—»</button>
            </div>
            <div>
              <h4 class="font-semibold">ä¸Šä¼ åª’ä½“</h4>
              <input id="fileInput" type="file" class="w-full mb-1" />
              <button id="uploadBtn" class="px-2 py-1 bg-blue-600 rounded">ä¸Šä¼ ç…§ç‰‡/è§†é¢‘</button>
            </div>
            <div>
              <h4 class="font-semibold">ç®¡ç†</h4>
              <div class="mb-2">
                <label class="small">åˆ é™¤æ–°é—» IDï¼š</label>
                <input id="delNewsId" class="p-1 text-black rounded w-full mb-1" />
                <button id="delNewsBtn" class="px-2 py-1 bg-red-600 rounded w-full">åˆ é™¤æ–°é—»</button>
              </div>
              <div class="mb-2">
                <label class="small">å¯¼å‡ºæœˆæŠ¥ï¼š</label>
                <input id="monthExport" placeholder="YYYY-MM" class="p-1 text-black rounded w-full mb-1" />
                <button id="exportBtn" class="px-2 py-1 bg-yellow-600 rounded w-full">ä¸‹è½½ CSV</button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- modal -->
  <div id="modal" class="modal-bg"><div class="modal-content bg-black p-2 rounded"><div id="modalInner"></div><div class="mt-2 text-right"><button id="closeModal" class="px-3 py-1 bg-gray-700 rounded">å…³é—­</button></div></div></div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let meName=null, role='user', currentTab='news', currentData={news:[],media:[],wishes:[]};

function el(id){ return document.getElementById(id); }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function setUserBox(){ el('userBox').innerHTML = meName?('<strong>'+meName+'</strong> ('+role+')'): 'æœªç™»å½•'; el('meName').innerText = meName||''; }

document.addEventListener('DOMContentLoaded', ()=>{
  el('loginBtn').addEventListener('click', loginHandler);
  el('nameInput').addEventListener('input', ()=>{ if(el('nameInput').value.trim()==='ç®¡ç†å‘˜') el('pwdInput').classList.remove('hidden'); else el('pwdInput').classList.add('hidden'); });
  el('searchBtn').addEventListener('click', doSearch);
  el('closeModal').addEventListener('click', ()=>{ el('modal').style.display='none'; el('modalInner').innerHTML=''; });
  document.querySelectorAll('.tab').forEach(b=> b.addEventListener('click', ()=>{ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('ring-4')); b.classList.add('ring-4'); currentTab=b.dataset.tab; render(); }));
  el('postNews').addEventListener('click', postNews);
  el('uploadBtn').addEventListener('click', uploadMedia);
  el('delNewsBtn').addEventListener('click', async ()=>{ const id=el('delNewsId').value.trim(); if(!id) return alert('å¡« id'); await fetch('/news/'+id,{method:'DELETE'}); alert('åˆ é™¤æˆåŠŸ'); });
  el('exportBtn').addEventListener('click', ()=>{ const m = el('monthExport').value.trim()||''; window.location = '/stats/export?month='+encodeURIComponent(m); });
  el('statsBtn').addEventListener('click', showStats);

  socket.on('update', d=>{ currentData = d; render(); });
  socket.on('onlineUsers', list=>{ el('onlineInfo').innerText = 'åœ¨çº¿: '+list.length+'äºº ('+list.join(',')+')'; });
  socket.on('connect', ()=>{ console.log('socket connected'); });
});

async function loginHandler(){
  const name = el('nameInput').value.trim(); const pwd = el('pwdInput').value;
  if(!/^[\u4e00-\u9fa5]{2,}$/.test(name)) return alert('å§“åé¡»ä¸ºä¸­æ–‡ä¸”è‡³å°‘2ä¸ªå­—');
  const res = await fetch('/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,password:pwd})});
  const j = await res.json(); if(!j.success) return alert(j.msg||'ç™»å½•å¤±è´¥');
  meName = name; role = j.role;
  el('loginArea').style.display='none'; el('appArea').style.display='block';
  if(role==='admin'){ el('adminPanel').style.display='block'; el('statsBtn').style.display='inline-block'; }
  setUserBox();
  socket.emit('register', meName);
  // fetch initial data
  const data = await fetch('/data').then(r=>r.json()); currentData = data; render();
}

function render(){
  const d = currentData || {news:[],media:[],wishes:[]};
  if(currentTab==='news'){ renderNews(d.news||[]); }
  else if(currentTab==='photos'){ renderPhotos((d.media||[]).filter(m=>m.type==='image')); }
  else if(currentTab==='videos'){ renderVideos((d.media||[]).filter(m=>m.type==='video')); }
  else if(currentTab==='wishes'){ renderWishes(d.wishes||[]); }
  else if(currentTab==='stats'){ /* handled separately */ }
}

function renderNews(news){
  const pinned = news.slice().sort((a,b)=>(b.pinned?1:0)-(a.pinned?1:0));
  if(!pinned.length){ el('contentArea').innerHTML = '<p class="text-gray-400">æš‚æ— æ–°é—»</p>'; return; }
  let html='';
  pinned.forEach(n=>{
    const title = escapeHtml(n.title); const content = escapeHtml(n.content);
    html += `<div class="p-4 bg-gray-800 rounded mb-3">
      <div class="flex justify-between items-start"><div><h3 class="font-bold">${title} ${n.pinned?'<span class="text-xs text-yellow-300">[ç½®é¡¶]</span>':''}</h3><div class="text-xs text-gray-400">${n.tag||''} â€¢ ${new Date(n.date).toLocaleString()}</div></div>
      <div class="text-right small">ğŸ‘ ${n.likes||0} <button onclick="likeItem('news','${n.id}')" class="ml-2 px-2 py-1 bg-gray-700 rounded small">ç‚¹èµ</button></div></div>
      <div class="mt-2">${content}</div>
      ${n.image?`<img src="${n.image}" class="mt-2 max-h-60 rounded cursor-pointer" onclick="openModal('image','${n.image}')">`:''}
      <div class="mt-3">${renderComments(n,'news')}</div>
      ${role==='admin'?`<div class="mt-2"><button onclick="pinItem('news','${n.id}',${n.pinned?0:1})" class="px-2 py-1 bg-yellow-600 rounded small">${n.pinned?'å–æ¶ˆç½®é¡¶':'ç½®é¡¶'}</button> <button onclick="deleteNews('${n.id}')" class="px-2 py-1 bg-red-600 rounded small">åˆ é™¤</button></div>`:''}
    </div>`;
  });
  el('contentArea').innerHTML = html;
}

function renderPhotos(list){
  if(!list.length){ el('contentArea').innerHTML = '<p class="text-gray-400">æš‚æ— ç…§ç‰‡</p>'; return; }
  let html = '<div class="grid grid-cols-3 gap-3">';
  list.forEach(m=>{
    html += `<div class="bg-gray-800 p-2 rounded"><img src="${m.filename}" class="w-full h-48 object-cover rounded cursor-pointer" onclick="openModal('image','${m.filename}')"><div class="text-xs text-gray-300 mt-1">ğŸ‘ ${m.likes||0} <button onclick="likeItem('media','${m.id}')" class="ml-2 px-2 py-1 bg-gray-700 rounded small">ç‚¹èµ</button></div><div class="mt-2">${renderComments(m,'media')}</div></div>`;
  });
  html += '</div>';
  el('contentArea').innerHTML = html;
}

function renderVideos(list){
  if(!list.length){ el('contentArea').innerHTML = '<p class="text-gray-400">æš‚æ— è§†é¢‘</p>'; return; }
  let html = '<div class="grid grid-cols-2 gap-3">';
  list.forEach(m=>{
    html += `<div class="bg-gray-800 p-2 rounded"><video src="${m.filename}" controls class="w-full rounded cursor-pointer" onclick="openModal('video','${m.filename}')"></video><div class="text-xs text-gray-300 mt-1">ğŸ‘ ${m.likes||0} <button onclick="likeItem('media','${m.id}')" class="ml-2 px-2 py-1 bg-gray-700 rounded small">ç‚¹èµ</button></div><div class="mt-2">${renderComments(m,'media')}</div></div>`;
  });
  html += '</div>';
  el('contentArea').innerHTML = html;
}

function renderWishes(list){
  if(!list.length){ el('contentArea').innerHTML = '<p class="text-gray-400">æš‚æ— æ„¿æœ›</p>'; return; }
  let html='';
  list.forEach(w=>{
    html += `<div class="p-3 bg-gray-800 rounded mb-2"><div class="flex justify-between"><div><strong>${escapeHtml(w.name)}</strong><div class="text-xs text-gray-400">${new Date(w.date).toLocaleString()}</div></div><div class="small">ğŸ‘ ${w.likes||0} <button onclick="likeItem('wishes','${w.id}')" class="ml-2 px-2 py-1 bg-gray-700 rounded small">ç‚¹èµ</button></div></div><div class="mt-2">${escapeHtml(w.text)}</div><div class="mt-2">${renderComments(w,'wishes')}</div>${role==='admin'?`<div class="mt-2"><button onclick="deleteWish('${w.id}')" class="px-2 py-1 bg-red-600 rounded small">åˆ é™¤</button></div>`:''}</div>`;
  });
  el('contentArea').innerHTML = html;
}

function renderComments(item,type){
  const comments = item.comments||[];
  let html = '<div class="space-y-2">';
  comments.slice().reverse().forEach(c=>{ // latest first
    const replies = (c.replies||[]).map(r=>`<div class="ml-4 text-sm text-gray-300">â†³ <strong>${escapeHtml(r.name)}</strong>: ${escapeHtml(r.text)} <span class="text-xs text-gray-500">(${new Date(r.date).toLocaleString()})</span></div>`).join('');
    html += `<div class="p-2 bg-gray-900 rounded"><div class="flex justify-between"><div class="text-sm"><strong>${escapeHtml(c.name)}</strong> <span class="text-xs text-gray-500">(${new Date(c.date).toLocaleString()})</span></div><div class="small">ğŸ‘ ${c.likes||0} <button onclick="likeComment('${type}','${item.id}','${c.id}')" class="ml-2 px-2 py-1 bg-gray-700 rounded small">èµè¯„è®º</button></div></div><div class="mt-1">${escapeHtml(c.text)}</div>${replies}<div class="mt-2 flex space-x-2"><input id="input_c_${item.id}_${c.id}" placeholder="å›å¤..." class="p-1 text-black rounded w-2/3" /><button onclick="postReply('${type}','${item.id}','${c.id}')" class="px-2 py-1 bg-indigo-600 rounded small">å›å¤</button>${role==='admin'?`<button onclick="deleteComment('${type}','${item.id}','${c.id}')" class="ml-2 px-2 py-1 bg-red-600 rounded small">åˆ é™¤è¯„è®º</button>`:''}</div></div>`;
  });
  html += `<div class="mt-2 flex space-x-2"><input id="input_new_${type}_${item.id}" placeholder="å†™è¯„è®º..." class="p-1 text-black rounded w-2/3" /><button onclick="postComment('${type}','${item.id}')" class="px-2 py-1 bg-green-600 rounded small">å‘è¡¨è¯„è®º</button></div>`;
  html += '</div>';
  return html;
}

// actions
async function postNews(){
  const title = el('newsTitle').value.trim(); const content = el('newsContent').value.trim(); const tag = el('newsTag').value; const pinned = el('newsPinned').checked;
  if(!title) return alert('è¯·è¾“å…¥æ ‡é¢˜');
  let imageUrl = null; const f = el('newsImageFile').files[0];
  if(f){ const fd = new FormData(); fd.append('file',f); fd.append('type','image'); fd.append('author',meName); const r = await fetch('/upload',{method:'POST',body:fd}); const j = await r.json(); if(j.success) imageUrl = j.item.filename; }
  await fetch('/news',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title,content,image:imageUrl,tag,pinned,author:meName})});
  el('newsTitle').value=''; el('newsContent').value=''; alert('å‘å¸ƒæˆåŠŸ');
}

async function uploadMedia(){
  const f = el('fileInput').files[0]; if(!f) return alert('è¯·é€‰æ‹©æ–‡ä»¶');
  const fd = new FormData(); fd.append('file',f); fd.append('type', f.type.startsWith('video')?'video':'image'); fd.append('author',meName);
  const r = await fetch('/upload',{method:'POST',body:fd}); const j = await r.json(); if(j.success) alert('ä¸Šä¼ æˆåŠŸ'); else alert('ä¸Šä¼ å¤±è´¥');
}

async function likeItem(type,id){ await fetch('/like',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type,id,name:meName||'åŒ¿å'})}); }

async function postComment(type,id){ const inp = el('input_new_'+type+'_'+id); const text = inp.value.trim(); if(!text) return; const anonymous = el('anonCheckbox').checked; await fetch('/comment',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type,id,name:meName||'åŒ¿å',text,anonymous})}); inp.value=''; }

async function postReply(type,id,commentId){ const input = el('input_c_'+id+'_'+commentId); const text = input.value.trim(); if(!text) return; const anonymous = el('anonCheckbox').checked; await fetch('/reply',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type,id,commentId,name:meName||'åŒ¿å',text,anonymous})}); input.value=''; }

async function likeComment(type,id,commentId){ await fetch('/likeComment',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type,id,commentId,name:meName||'åŒ¿å'})}); }

async function deleteComment(type,id,commentId){ if(!confirm('ç¡®è®¤åˆ é™¤è¯„è®ºï¼Ÿ')) return; await fetch('/comment/'+type+'/'+id+'/'+commentId,{method:'DELETE'}); alert('åˆ é™¤æˆåŠŸ'); }

async function deleteNews(id){ if(!confirm('ç¡®è®¤åˆ é™¤æ–°é—»ï¼Ÿ')) return; await fetch('/news/'+id,{method:'DELETE'}); alert('åˆ é™¤æˆåŠŸ'); }

async function deleteWish(id){ if(!confirm('ç¡®è®¤åˆ é™¤æ„¿æœ›ï¼Ÿ')) return; await fetch('/wish/'+id,{method:'DELETE'}); alert('åˆ é™¤æˆåŠŸ'); }

async function pinItem(type,id,pinned){ await fetch('/pin',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type,id,pinned:!!pinned})}); }

async function doSearch(){ const q = el('searchInput').value.trim(); if(!q) return alert('è¾“å…¥å…³é”®è¯'); const res = await fetch('/search?q='+encodeURIComponent(q)); const j = await res.json(); if(!j.success) return alert('æœç´¢å¤±è´¥'); currentData = {news:j.results.news, media:[], wishes:j.results.wishes}; currentTab='news'; render(); highlight(q); }

function highlight(q){ // simple highlight in content area
  const nodes = el('contentArea').querySelectorAll('*');
  nodes.forEach(n=>{ if(n.childNodes && n.childNodes.length && n.innerText){ const re = new RegExp(q,'ig'); if(re.test(n.innerText)){ n.innerHTML = n.innerText.replace(re, m=>`<span class="highlight">${m}</span>`); } } }); }

function openModal(kind,src){ el('modal').style.display='flex'; if(kind==='image'){ el('modalInner').innerHTML = `<img src="${src}" class="modal-content rounded">`; } else if(kind==='video'){ el('modalInner').innerHTML = `<video src="${src}" controls autoplay class="modal-content rounded"></video>`; } }

async function showStats(){ currentTab='stats'; // fetch today's summary
  const res = await fetch('/stats/today'); const j = await res.json(); if(!j.success) return alert('è·å–ç»Ÿè®¡å¤±è´¥'); let html = `<div class="p-4 bg-gray-800 rounded"><h3 class="font-bold">ä»Šæ—¥ç»Ÿè®¡ (${j.date})</h3><div class="mt-2">ç™»å½•äººæ•°: ${j.logins}</div><h4 class="mt-2">ä»Šæ—¥ç‚¹èµï¼ˆæ˜ç»†ï¼‰</h4><pre class="text-xs text-gray-300">${escapeHtml(JSON.stringify(j.likes,null,2))}</pre></div>`; el('contentArea').innerHTML = html; }

// init
(function(){ socket.on('update', d=>{ currentData = d; if(document.querySelector('.tab.ring-4')){ currentTab = document.querySelector('.tab.ring-4').dataset.tab; } render(); }); socket.on('onlineUsers', list=>{ el('onlineInfo').innerText = 'åœ¨çº¿: '+list.length+'äºº ('+list.join(',')+')'; }); })();

</script>
</body>
</html>